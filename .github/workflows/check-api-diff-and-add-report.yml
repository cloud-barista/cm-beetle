name: Check API Diff and Add Report by PR

on:
  workflow_dispatch:
    inputs:
      previous_tag:
        description: "Previous Tag (e.g., v0.4.1)"
        required: true
      target_branch:
        description: "Target branch (e.g., main)"
        required: true
        default: "main"

env:
  API_DOC_PATH: api/swagger.yaml
  REPORT_FILE_PATH: api/api-diff.md

jobs:
  generate_and_create_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Install DeepDiffGo
        run: |
          go install github.com/cloud-barista/cm-beetle/deepdiffgo/cmd/deepdiffgo@latest

      - name: Get Target Branch Short SHA
        id: get_sha
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Target branch HEAD short SHA: $SHORT_SHA"

      - name: Generate API Diff Report
        id: deepdiff
        run: |
          # ========================================================
          # 1. Setup Variables
          # ========================================================
          PREV_TAG="${{ inputs.previous_tag }}"
          REPORT_FILE="${{ env.REPORT_FILE_PATH }}"
          PREV_SPEC_FILE="prev_spec.yaml"
          CURR_SPEC_FILE="${{ env.API_DOC_PATH }}"

          # ========================================================
          # 2. Extract Previous API Spec (from Tag)
          # ========================================================
          echo "Extracting '${{ env.API_DOC_PATH }}' from tag '$PREV_TAG'..."

          if git show "$PREV_TAG:${{ env.API_DOC_PATH }}" > "$PREV_SPEC_FILE"; then
            echo "Successfully extracted previous spec."
          else
            echo "Error: Could not extract '${{ env.API_DOC_PATH }}' from tag '$PREV_TAG'."
            exit 1
          fi

          # Ensure output directory exists
          mkdir -p $(dirname "$REPORT_FILE")

          # ========================================================
          # 3. Execute DeepDiffGo
          # ========================================================
          echo "Running DeepDiffGo..."
          if deepdiffgo "$PREV_SPEC_FILE" "$CURR_SPEC_FILE" --format markdown --output "$REPORT_FILE"; then
            echo "DeepDiffGo completed successfully."
          else
            echo "DeepDiffGo failed execution."
            exit 1
          fi

          # ========================================================
          # 4. Check for Changes and Prepare PR Body
          # ========================================================
          if grep -q "No changes found." "$REPORT_FILE"; then
            echo "No API changes detected. Skipping PR creation."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "API changes detected."
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            echo "report_body_brief<<EOF" >> $GITHUB_OUTPUT
            head -n 20 "$REPORT_FILE" >> $GITHUB_OUTPUT
            echo "..." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: ${{ steps.deepdiff.outputs.has_changes == 'true' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.CR_PAT }} # Replace with appropriate token if needed (e.g., secrets.GITHUB_TOKEN)
          commit-message: "Docs: Add API Diff Report for ${{ inputs.previous_tag }} to ${{ inputs.target_branch }} (${{ steps.get_sha.outputs.short_sha }})"
          branch: "docs/api-diff-with-${{ inputs.previous_tag }}"
          base: ${{ inputs.target_branch }}
          title: "[Report] API Diff: ${{ inputs.previous_tag }} to ${{ inputs.target_branch }} (${{ steps.get_sha.outputs.short_sha }})"
          body: |
            ## ðŸ“œ API Diff Report

            This PR adds the API difference report between tag **${{ inputs.previous_tag }}** and branch **${{ inputs.target_branch }}** (`${{ steps.get_sha.outputs.short_sha }}`).

            Please review the **${{ env.REPORT_FILE_PATH }}** file.

            ---
            **Report Preview (First 20 lines):**
            ${{ steps.deepdiff.outputs.report_body_brief }}
          add-paths: |
            ${{ env.REPORT_FILE_PATH }}
          delete-branch: true
